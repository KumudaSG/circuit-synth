services:
  # Main Circuit-Synth service with native KiCad 9 build for ARM64
  circuit-synth-kicad:
    build:
      context: ..
      dockerfile: docker/Dockerfile.kicad-arm64
    container_name: circuit-synth-kicad-native
    volumes:
      # Mount source code for development
      - ../src:/app/src
      - ../examples:/app/examples
      - ../tests:/app/tests
      # Mount output directory for generated files
      - ../output:/app/output
      # Mount cache directory for persistence
      - ../cache:/app/cache
      # Mount KiCad projects directory
      - ../kicad_projects:/app/kicad_projects
      # KiCad user config persistence
      - kicad_config:/home/circuit_synth/.config
    environment:
      - PYTHONPATH=/app/src
      - RUST_LOG=info
      # KiCad environment variables
      - KICAD_CONFIG_HOME=/home/circuit_synth/.config/kicad
      - KICAD_SYMBOL_DIR=/usr/share/kicad/symbols
      - KICAD_FOOTPRINT_DIR=/usr/share/kicad/footprints
      - KICAD_3DMODEL_DIR=/usr/share/kicad/3dmodels
    working_dir: /app
    command: >
      python -c "
      import circuit_synth; 
      import subprocess;
      print('Circuit Synth with native KiCad 9 (ARM64) is ready!');
      result = subprocess.run(['kicad-cli', 'version'], capture_output=True, text=True);
      print(f'KiCad CLI Version: {result.stdout.strip()}')
      "
    
  # Development service with interactive shell
  circuit-synth-kicad-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.kicad-arm64
    container_name: circuit-synth-kicad-dev-native
    volumes:
      - ../src:/app/src
      - ../examples:/app/examples
      - ../tests:/app/tests
      - ../output:/app/output
      - ../cache:/app/cache
      - ../kicad_projects:/app/kicad_projects
      - kicad_config:/home/circuit_synth/.config
    environment:
      - PYTHONPATH=/app/src
      - RUST_LOG=debug
      - KICAD_CONFIG_HOME=/home/circuit_synth/.config/kicad
      - KICAD_SYMBOL_DIR=/usr/share/kicad/symbols
      - KICAD_FOOTPRINT_DIR=/usr/share/kicad/footprints
      - KICAD_3DMODEL_DIR=/usr/share/kicad/3dmodels
    working_dir: /app
    stdin_open: true
    tty: true
    command: /bin/bash
    
  # Test service with comprehensive integration testing
  circuit-synth-kicad-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.kicad-arm64
    container_name: circuit-synth-kicad-test-native
    volumes:
      - ../src:/app/src
      - ../tests:/app/tests
      - ../test_output:/app/test_output
      - ../kicad_projects:/app/kicad_projects
    environment:
      - PYTHONPATH=/app/src
      - RUST_LOG=info
      - KICAD_CONFIG_HOME=/home/circuit_synth/.config/kicad
      - KICAD_SYMBOL_DIR=/usr/share/kicad/symbols
      - KICAD_FOOTPRINT_DIR=/usr/share/kicad/footprints
      - KICAD_3DMODEL_DIR=/usr/share/kicad/3dmodels
    working_dir: /app
    command: |
      bash -c "
        echo '=== Circuit-Synth + Native KiCad 9 Integration Tests ==='
        echo 'Architecture:' && uname -m
        echo 'KiCad Version:' && kicad-cli version
        echo 'Library Status:'
        ls -la /usr/share/kicad/symbols/ | head -5
        ls -la /usr/share/kicad/footprints/ | head -5
        echo 'Circuit-Synth Import Test:'
        python -c 'import circuit_synth; print(\"âœ… Circuit-Synth imported successfully\")'
        echo 'Running pytest...'
        python -m pytest tests/ -v --tb=short -x
      "

  # KiCad CLI utilities service (for standalone KiCad operations)
  kicad-cli:
    build:
      context: ..
      dockerfile: docker/Dockerfile.kicad-arm64
    container_name: kicad-cli-native
    volumes:
      - ../kicad_projects:/app/kicad_projects
      - ../output:/app/output
      - kicad_config:/home/circuit_synth/.config
    environment:
      - KICAD_CONFIG_HOME=/home/circuit_synth/.config/kicad
      - KICAD_SYMBOL_DIR=/usr/share/kicad/symbols
      - KICAD_FOOTPRINT_DIR=/usr/share/kicad/footprints
      - KICAD_3DMODEL_DIR=/usr/share/kicad/3dmodels
    working_dir: /app/kicad_projects
    entrypoint: ["kicad-cli"]
    # Usage: docker-compose -f docker/docker-compose.kicad-arm64.yml run kicad-cli sch export pdf --help

volumes:
  kicad_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./docker/kicad_config

networks:
  default:
    name: circuit-synth-kicad-native-network